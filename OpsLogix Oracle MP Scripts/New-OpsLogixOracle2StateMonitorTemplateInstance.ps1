Function New-OpsLogixOracle2StateMonitorTemplateInstance
{
<# 
 .Synopsis
  Create a OpsLogix Oracle Two-State Monior monitoring template instance in OpsMgr.

 .Description
  Create a OpsLogix Oracle Two-State Monior monitoring template instance in OpsMgr using OpsMgr SDK. A boolean value $true will be returned if the monitoring template instance creation has been successful, otherwise, a boolean value of $false is returned if any there are any errors occurred during the creation process.

 .Parameter -SDKConnection
  OpsMgr SDK Connection object (SMA/Azure Automation connection or hash table).

 .Parameter -SDK
  Management Server name

 .Parameter -UserName
  Alternative user name to connect to the management group (optional).

 .Parameter -Password
  Alternative password to connect to the management group (optional).

 .Parameter -MPName
  Name for the unsealed MP of which the OpsLogix Oracle Two-State Monior monitoring template instance is going to stored.

 .Parameter -DisplayName
  The OpsLogix Oracle Two-State Monior Template instance display name

 .Parameter -Description
  The OpsLogix Oracle Two-State Monior Template instance description

 .Parameter -Enabled
  Specify if the Rules and Monitors created by the template are enabled by default. this is a boolean parameter. the default value is set to $true if not specified.

 .Parameter -Query
  Specify the query to be executed by the Opslogix Oracle two-state monitor

 .Parameter -ReturnColumnName
  Specify the return column name from the query

 .Parameter -Target
  The target class of the monitor. Possible values are (case insensitive): 'Instance'; 'Control File'; 'Data File'; 'Redo Log group'; 'Redo Log File'; "Table Space"

 .Parameter -MonitorState
  The unhealthy state of the monitor. Possible values are (case insensitive): 'Warning'; 'Error'

 .Parameter -LocaleId
  The Locale ID for the language pack items. This is an optional parameter, if not specifiied, the value "ENU" is used.

 .Parameter -QueryInterval
  The query interval in seconds, the default value is 300 (5 minutes) if it is not specified.

 .Parameter -Operator
  Specify the Operator used to evaluate the query returned value. Possible values are (case insensitive): 'Greater'; 'GreaterEqual'; 'Less'; 'LessEqual'; 'Equal'; 'NotEqual'

 .Parameter -TargetValue
  Specify the target value used to evaluate the query result.

 .Parameter -AlertName
  The name of the alert generated by the monitor

 .Parameter -AlertDescription
  The description of the alert generated by the monitor

 .Parameter -AlertPriority
  The priority of the alert generated by the monitor. Possible values are (case insensitive): 'Low'; 'Normal'; 'High'. the default value is 'Medium' if not specified.

 .Parameter -AlertSeverity
  The severity of the alert generated by the monitor. Possible values are (case insensitive): 'Information'; 'Warning'; 'Error'. the default value is 'Warning' if not specified.

 .Parameter -IncreaseMPVersion
  Increase MP version by 0.0.0.1 (Increase revision by 1).

 .Example
  # Connect to OpsMgr management group via management server "OpsMgrMS01" and then create an OpsLogix Oracle Two-State Monior template instance with the following properties:
   $parms = @{
        SDK = "OpsMgrMS01";
        UserName = "domain\SCOM.Admin"
        Password = $(ConvertTo-SecureString -AsPlainText "password1234" -force);
        MPName = "TYANG.Lab.Test";
        DisplayName = "Test Oracle two-state monitor";
        Description = "This is a test instance for the OpsLogix Oracle Two-State Monior template";
        Enabled = $true;
        Query = 'select count(*) "Order_COUNT" from sys.orders';
        ReturnColumnName = "Order_COUNT";
        Target="Instance";
        MonitorState="Error";
        QueryInterval = 300;
        UnhealthyOperator = "Greater";
        TargetValue = 300;
        AlertName= "The Order Table Has too many rows";
        AlertDescription = "please check the order table, it has too many outstanding rows.";
        AlertPriority = "Medium";
        AlertSeverity = "Critical"
   }
  
  New-OpsLogixOracle2StateMonitorTemplateInstance @parms
#>
    [CmdletBinding()]
    PARAM (
        [Parameter(ParameterSetName='SMAConnection',Mandatory=$true,HelpMessage='Please specify the SMA Connection object')][Alias('Connection','c')][Object]$SDKConnection,
		[Parameter(ParameterSetName='IndividualParameter',Mandatory=$true,HelpMessage='Please enter the Management Server name')][Alias('DAS','Server','s')][String]$SDK,
        [Parameter(ParameterSetName='IndividualParameter',Mandatory=$false,HelpMessage='Please enter the user name to connect to the OpsMgr management group')][Alias('u')][String]$Username = $null,
        [Parameter(ParameterSetName='IndividualParameter',Mandatory=$false,HelpMessage='Please enter the password to connect to the OpsMgr management group')][Alias('p')][SecureString]$Password = $null,
        [Parameter(Mandatory=$true,HelpMessage='Please enter management pack name')][ValidateNotNullOrEmpty()][String]$MPName,
        [Parameter(Mandatory=$true,HelpMessage='Please enter Template Instance Display Name')][ValidateNotNullOrEmpty()][String]$DisplayName,
        [Parameter(Mandatory=$true,HelpMessage='Please enter Template Instance description')][String]$Description,
        [Parameter(Mandatory=$false,HelpMessage='Please specify if the monitor is enabled by default')][Boolean]$Enabled=$true,
        [Parameter(Mandatory=$true,HelpMessage='Please enter the query executed by the monitor')][ValidateNotNullOrEmpty()][String]$Query,
        [Parameter(Mandatory=$true,HelpMessage='Please enter the return column name')][ValidateNotNullOrEmpty()][String]$ReturnColumnName,
        [Parameter(Mandatory=$true,HelpMessage='Please select target class of the monitor')][ValidateSet('Instance', 'Control File', 'Data File', 'Redo Log group', 'Redo Log File', 'Table Space')][String]$Target,
        [Parameter(Mandatory=$true,HelpMessage='Please select unhealthy state of the monitor')][ValidateSet('Warning', 'Error')][String]$MonitorState,
        [Parameter(Mandatory=$false,HelpMessage='Please enter the Management Pack Locale ID')][ValidateNotNullOrEmpty()][String]$LocaleId="ENU",
        [Parameter(Mandatory=$false,HelpMessage='Please enter the query interval (in seconds)')][Int]$QueryInterval=300,
        [Parameter(Mandatory=$true,HelpMessage='Please select the operator for the monitor unhealthy state')][ValidateSet('Greater', 'GreaterEqual', 'Less', 'LessEqual', 'Equal', 'NotEqual')][String]$UnhealthyOperator,
        [Parameter(Mandatory=$true,HelpMessage='Please enter the target value that will be used in the alert criteria')][Int]$TargetValue,
        [Parameter(Mandatory=$true,HelpMessage='Please enter the alert name')][ValidateNotNullOrEmpty()][String]$AlertName,
        [Parameter(Mandatory=$true,HelpMessage='Please enter the alert description')][ValidateNotNullOrEmpty()][String]$AlertDescription,
        [Parameter(Mandatory=$true,HelpMessage='Please specify the alert priority')][ValidateSet('Low', 'Normal', 'High')][String]$AlertPriority,
        [Parameter(Mandatory=$true,HelpMessage='Please specify the alert severity')][ValidateSet('Information', 'Warning', 'Error')][String]$AlertSeverity,
        [Parameter(Mandatory=$false,HelpMessage='Increase MP version by 0.0.0.1')][Boolean]$IncreaseMPVersion = $false
    )

    #Connect to MG
	If ($SDKConnection)
	{
		Write-Verbose "Connecting to Management Group via SDK $($SDKConnection.ComputerName)`..."
		$MG = Connect-OMManagementGroup -SDKConnection $SDKConnection
		$SDK = $SDKConnection.ComputerName
		$Username = $SDKConnection.Username
		$Password= ConvertTo-SecureString -AsPlainText $SDKConnection.Password -force
	} else {
		Write-Verbose "Connecting to Management Group via SDK $SDK`..."
		If ($Username -and $Password)
		{
			$MG = Connect-OMManagementGroup -SDK $SDK -UserName $Username -Password $Password
		} else {
			$MG = Connect-OMManagementGroup -SDK $SDK
		}
	}

    #Get the unsealed MP
    Write-Verbose "Getting destination MP '$MPName'..."
    $strMPquery = "Name = '$MPName'"
    $mpCriteria = New-Object  Microsoft.EnterpriseManagement.Configuration.ManagementPackCriteria($strMPquery)
    $MP = $MG.ManagementPacks.GetManagementPacks($mpCriteria)[0]

    If ($MP)
    {
        #MP found, now check if it is sealed
        Write-Verbose "Found destination MP '$MPName', the MP display name is '$($MP.DisplayName)'. MP Sealed: $($MP.Sealed)"
        If ($MP.sealed)
        {
            Write-Error 'Unable to save to the management pack specified. It is sealed. Please specify an unsealed MP.'
            return $false
        }
    } else {
        Write-Error 'The management pack specified cannot be found. please make sure the correct name is specified.'
        return $false
    }

    #Get the target class
    Switch ($Target.ToLower())
    {
        'instance' {$TargetClass = 'OpsLogix.IMP.Oracle.Instance'}
        'control file' {$TargetClass = 'OpsLogix.IMP.Oracle.ControlFile'}
        'data file' {$TargetClass = 'OpsLogix.IMP.Oracle.DataFile'}
        'redo log group' {$TargetClass = 'OpsLogix.IMP.Oracle.RedoLogGroup'}
        'redo log file' {$TargetClass = 'OpsLogix.IMP.Oracle.RedoLogFile'}
        'table space' {$TargetClass = 'OpsLogix.IMP.Oracle.TableSpace'}
    }

    #get the healthy operator
        Switch ($UnhealthyOperator.ToLower())
    {
        'greater' {$HealthyOperator = 'LessEqual'}
        'greaterequal' {$HealthyOperator = 'Less'}
        'less' {$HealthyOperator = 'GreaterEqual'}
        'lessequal' {$HealthyOperator = 'Greater'}
        'equal' {$HealthyOperator = 'NotEqual'}
        'notequal' {$HealthyOperator = 'Equal'}
    }

    #Get the template
    Write-Verbose "Getting the OpsLogix Oracle Two-State Monitor monitoring template..."
    $strTemplatequery = "Name = 'OpsLogix.IMP.Oracle.Config.2012.2State.Monitor.Template'"
    $TemplateCriteria = New-object Microsoft.EnterpriseManagement.Configuration.ManagementPackTemplateCriteria($strTemplatequery)
    $OpsLogixOracle2StateMonitorTemplate = $MG.GetMonitoringTemplates($TemplateCriteria)[0]
    if (!$OpsLogixOracle2StateMonitorTemplate)
    {
        Write-Error "The Opslogix Oracle Two-State Monitor Monitoring Template cannot be found. please make sure the OpsLogix Oracle management packs are imported into your management group."
        return $false
    }

    #Generate template instance configuration
    $NewGUID = [GUID]::NewGuid().ToString().Replace("-","")
    $NameSpace = "OpsLogixOracleAlertTemplate_$NewGUID"
    $StringBuilder = New-Object System.Text.StringBuilder
    $configurationWriter = [System.Xml.XmlWriter]::Create($StringBuilder)
    $configurationWriter.WriteStartElement("Configuration");
    $configurationWriter.WriteElementString("Name", $DisplayName);
    $configurationWriter.WriteElementString("Description", $Description);
    $configurationWriter.WriteElementString("LocaleId", $LocaleId);
    $configurationWriter.WriteElementString("NameSpace", $NameSpace);
    $configurationWriter.WriteElementString("Enabled", $Enabled.ToString().ToLower());
    $configurationWriter.WriteElementString("HostReference", "");
    $configurationWriter.WriteElementString("ManagementPack", $MPName);
    $configurationWriter.WriteElementString("ColumnName", $ReturnColumnName);
    $configurationWriter.WriteElementString("Query", $Query);
    $configurationWriter.WriteElementString("IntervalSeconds", $QueryInterval);
    $configurationWriter.WriteElementString("Target", $TargetClass);
    $configurationWriter.WriteElementString("State", $MonitorState);
    $configurationWriter.WriteElementString("HealthyOperator", $HealthyOperator);
    $configurationWriter.WriteElementString("CriticalOperator", $UnhealthyOperator);
    $configurationWriter.WriteElementString("Value", $TargetValue);
    $configurationWriter.WriteElementString("AlertName", $AlertName);
    $configurationWriter.WriteElementString("AlertDescription", $AlertDescription);
    $configurationWriter.WriteElementString("AlertPriority", $AlertPriority);
    $configurationWriter.WriteElementString("AlertSeverity", $AlertSeverity);
    $configurationWriter.WriteEndElement();
    $configurationWriter.Flush();
    $XmlWriter = New-Object Microsoft.EnterpriseManagement.Configuration.IO.ManagementPackXmlWriter([System.Xml.XmlWriter]::Create($StringBuilder))
    $strConfiguration = $StringBuilder.ToString()
    Write-Verbose "Template Instance Configuration:"
    Write-Verbose $strConfiguration
    #Create the template instance
    Write-Verbose "Creating the OpsLogix Oracle Two-State Monitor template instance on management pack '$MPName'..."
    Try {
        [Void]$MP.ProcessMonitoringTemplate($OpsLogixOracle2StateMonitorTemplate, $strConfiguration, "TemplateoutputOpsLogixIMPOracleConfig20122StateMonitorTemplate$NewGUID", $DisplayName, $Description)
    } Catch {
        Write-Error $_.Exception.InnerException
        Return $False
    }
    #Increase MP version
    If ($IncreaseMPVersion)
    {
        Write-Verbose "the version of managemnet pack '$MPVersion' will be increased by 0.0.0.1"
        $CurrentVersion = $MP.Version.Tostring()
        $vIncrement = $CurrentVersion.Split('.')
        $vIncrement[$vIncrement.Length - 1] = ([System.Int32]::Parse($vIncrement[$vIncrement.Length - 1]) + 1).ToString()
        $NewVersion = ([System.String]::Join('.', $vIncrement))
        $MP.Version = $NewVersion
    }

    #Verify and save the monitor
    Try {
        $MP.verify()
        $MP.AcceptChanges()
        $Result = $true
		Write-Verbose "OpsLogix Oracle Two-State Monitor template instance '$DisplayName' successfully created in Management Pack '$MPName'($($MP.Version))."
    } Catch {
        $Result = $false
		$MP.RejectChanges()
        Write-Error "Unable to create OpsLogix Oracle Two-State Monitor template instance '$DisplayName' in management pack $MPName."
    }
    $Result
}